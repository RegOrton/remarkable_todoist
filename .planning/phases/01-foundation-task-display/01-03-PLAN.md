---
phase: 01-foundation-task-display
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/views/tasklistview.h
  - src/views/tasklistview.cpp
  - src/views/taskdelegate.h
  - src/views/taskdelegate.cpp
autonomous: true

must_haves:
  truths:
    - "Tasks are rendered with name, due date, project, and priority"
    - "Checkboxes are visible and sized for stylus input (48x48dp)"
    - "Task list is scrollable"
    - "UI has high contrast for e-ink display"
  artifacts:
    - path: "src/views/tasklistview.h"
      provides: "Scrollable task list view"
      contains: "class TaskListView : public QListView"
    - path: "src/views/taskdelegate.h"
      provides: "Custom task row rendering"
      contains: "class TaskDelegate : public QStyledItemDelegate"
  key_links:
    - from: "src/views/taskdelegate.cpp"
      to: "src/models/taskmodel.h"
      via: "uses TaskModel roles"
      pattern: "TaskModel::"
---

<objective>
Implement the UI layer for displaying tasks in a scrollable list with custom rendering optimized for e-ink.

Purpose: Creates the visual representation of tasks. The delegate renders each task row with checkbox, title, due date, project name, and priority indicator. Designed for e-ink constraints (high contrast, large touch targets).

Output: TaskListView (QListView subclass) and TaskDelegate (QStyledItemDelegate) that render tasks appropriately for reMarkable 2.
</objective>

<execution_context>
@/home/reg/.claude/get-shit-done/workflows/execute-plan.md
@/home/reg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-task-display/01-RESEARCH.md
@.planning/phases/01-foundation-task-display/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TaskDelegate for custom task row rendering</name>
  <files>
    src/views/taskdelegate.h
    src/views/taskdelegate.cpp
  </files>
  <action>
Create TaskDelegate class (src/views/taskdelegate.h, taskdelegate.cpp):

Header:
- Include QStyledItemDelegate, QPainter, QStyleOptionViewItem
- Class inherits QStyledItemDelegate
- Q_OBJECT macro

Layout design (optimized for e-ink, stylus input):
```
Row height: 80px minimum (allows for touch scrolling)
+--------------------------------------------------+
| [checkbox 48x48]  Task Title (bold, 16pt)        |
|                   Project | Due Date | P1        |
+--------------------------------------------------+
Margins: 12px left, 12px right, 8px top/bottom between rows
Checkbox: 48x48px with 12px padding from left edge
Title: Bold, 16pt font, black text
Metadata: Regular, 12pt font, dark gray (#333)
Priority: Bold text, e.g., "P1" "P2" etc.
```

Override methods:

paint(QPainter*, const QStyleOptionViewItem&, const QModelIndex&):
- Draw checkbox (48x48 rect at left)
  - 2px black border
  - If completed: draw X inside (or filled square)
- Draw task title (bold, 16pt, to right of checkbox)
  - If completed: strikethrough
- Draw metadata row below title:
  - Project name (if exists)
  - Separator "|"
  - Due date formatted (if exists)
  - Separator "|"
  - Priority label (P1/P2/P3/P4 if not default)
- Use high contrast: black on white, no grays for text

sizeHint(const QStyleOptionViewItem&, const QModelIndex&):
- Return QSize(option.rect.width(), 80) for consistent row height
- 80px provides adequate space for two lines + padding

Colors (e-ink optimized):
- Text: black (#000000)
- Checkbox border: black 2px
- Background: white (default)
- Completed task text: gray (#666666) with strikethrough
- No gradients, no anti-aliased curves on checkbox

Constants to define:
```cpp
const int ROW_HEIGHT = 80;
const int CHECKBOX_SIZE = 48;
const int CHECKBOX_MARGIN = 12;
const int TEXT_MARGIN = 12;
const int TITLE_FONT_SIZE = 16;
const int METADATA_FONT_SIZE = 12;
```

Update CMakeLists.txt to include taskdelegate.cpp
  </action>
  <verify>
Code compiles. TaskDelegate can be instantiated. Visual verification deferred to integration plan.
  </verify>
  <done>
TaskDelegate renders task rows with checkbox (48x48), title (bold), and metadata (project, date, priority) in high-contrast e-ink style.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement TaskListView with e-ink refresh management</name>
  <files>
    src/views/tasklistview.h
    src/views/tasklistview.cpp
  </files>
  <action>
Create TaskListView class (src/views/tasklistview.h, tasklistview.cpp):

Header:
- Include QListView
- Class inherits QListView
- Q_OBJECT macro

Constructor:
- Call parent QListView constructor
- Set viewport properties for e-ink:
  - setVerticalScrollMode(QAbstractItemView::ScrollPerPixel) for smooth scrolling
  - setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff)
  - setVerticalScrollBarPolicy(Qt::ScrollBarAsNeeded)
  - setSelectionMode(QAbstractItemView::SingleSelection)
  - setEditTriggers(QAbstractItemView::NoEditTriggers)
- Apply high-contrast styling:
  - Background white
  - No alternating row colors (keep simple for e-ink)
- Create and set TaskDelegate as item delegate
- Configure scrollbar styling (thick for touch)

Style (setStyleSheet or palette):
```cpp
setStyleSheet(R"(
    QListView {
        background-color: white;
        border: none;
    }
    QListView::item {
        border-bottom: 1px solid #cccccc;
    }
    QScrollBar:vertical {
        width: 20px;
        background: #f0f0f0;
    }
    QScrollBar::handle:vertical {
        background: #888888;
        min-height: 40px;
        border-radius: 4px;
    }
)");
```

E-ink refresh management (simplified for Phase 1):
- Override dataChanged to track partial refreshes
- Counter for partial updates
- After MAX_PARTIAL_REFRESHES (5), trigger full repaint
- Add method: void triggerFullRefresh()

Member variables:
```cpp
private:
    int m_partialRefreshCount = 0;
    static const int MAX_PARTIAL_REFRESHES = 5;
```

Override:
```cpp
void dataChanged(const QModelIndex &topLeft, const QModelIndex &bottomRight,
                 const QVector<int> &roles = QVector<int>()) override;
```

Note: Actual rm2fb integration for waveform control is complex and may require device testing. For Phase 1, use standard Qt update mechanisms which rm2fb intercepts. The refresh counter is preparatory infrastructure.

Update CMakeLists.txt to include tasklistview.cpp
  </action>
  <verify>
Code compiles. TaskListView can be instantiated. Has TaskDelegate assigned. Scrollbar styling applied.
  </verify>
  <done>
TaskListView configured for e-ink: vertical scrolling, high-contrast styling, touch-friendly scrollbar, TaskDelegate attached, refresh tracking infrastructure.
  </done>
</task>

</tasks>

<verification>
1. `cmake -B build && cmake --build build` compiles without errors
2. TaskDelegate exists with paint() and sizeHint() implementations
3. TaskListView exists with proper configuration
4. Checkbox size is 48x48 (meets touch target requirement)
5. Row height is 80px
6. High-contrast styling applied (black on white)
7. TaskDelegate renders title, project, date, priority
</verification>

<success_criteria>
- TaskDelegate renders: checkbox (48x48), task title (bold 16pt), metadata row (project, date, priority)
- TaskListView: vertical scroll, no horizontal scroll, touch-friendly scrollbar
- High contrast design: black text on white background
- Row height adequate for two-line display (80px)
- E-ink refresh tracking infrastructure in place
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-task-display/01-03-SUMMARY.md`
</output>
