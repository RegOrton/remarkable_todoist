---
phase: 01-foundation-task-display
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/network/todoist_client.h
  - src/network/todoist_client.cpp
autonomous: true

must_haves:
  truths:
    - "App can fetch tasks from Todoist API"
    - "API errors are handled gracefully"
    - "Network replies are properly cleaned up"
  artifacts:
    - path: "src/network/todoist_client.h"
      provides: "Todoist REST API wrapper"
      contains: "class TodoistClient"
    - path: "src/network/todoist_client.cpp"
      provides: "API implementation"
      contains: "QNetworkAccessManager"
  key_links:
    - from: "src/network/todoist_client.cpp"
      to: "src/models/task.h"
      via: "creates Task from JSON"
      pattern: "Task::fromJson"
    - from: "src/network/todoist_client.cpp"
      to: "https://api.todoist.com/rest/v2/tasks"
      via: "HTTP GET request"
      pattern: "api\\.todoist\\.com"
---

<objective>
Implement the Todoist REST API v2 client for fetching tasks.

Purpose: Provides the network layer to retrieve task data from Todoist. This is the data source for the entire application.

Output: Working TodoistClient class that fetches all tasks from Todoist API and converts them to Task structs.
</objective>

<execution_context>
@/home/reg/.claude/get-shit-done/workflows/execute-plan.md
@/home/reg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-task-display/01-RESEARCH.md
@.planning/phases/01-foundation-task-display/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TodoistClient with task fetching</name>
  <files>
    src/network/todoist_client.h
    src/network/todoist_client.cpp
  </files>
  <action>
Create TodoistClient class (src/network/todoist_client.h, todoist_client.cpp):

Header:
- Include QObject, QNetworkAccessManager, QNetworkReply
- Forward declare Task (or include task.h)
- Class inherits QObject
- Q_OBJECT macro

Constructor:
- `TodoistClient(const QString& apiToken, QObject* parent = nullptr)`
- Create single QNetworkAccessManager instance (parent = this for auto-cleanup)
- Store apiToken in member variable

Public methods:
- `void fetchAllTasks()` - initiates async request to get all tasks
- `void fetchProjects()` - initiates async request to get all projects (needed for project names)

Signals:
- `void tasksFetched(const QVector<Task>& tasks)`
- `void projectsFetched(const QMap<QString, QString>& projects)` - map of projectId -> projectName
- `void errorOccurred(const QString& error)`

Private slots:
- `void onTasksReplyFinished()`
- `void onProjectsReplyFinished()`

Private members:
- QNetworkAccessManager* m_networkManager
- QString m_apiToken
- QMap<QString, QString> m_projectNames (cache project id -> name mapping)

Implementation:

fetchAllTasks():
```cpp
QUrl url("https://api.todoist.com/rest/v2/tasks");
QNetworkRequest request(url);
request.setRawHeader("Authorization", QString("Bearer %1").arg(m_apiToken).toUtf8());
QNetworkReply* reply = m_networkManager->get(request);
connect(reply, &QNetworkReply::finished, this, &TodoistClient::onTasksReplyFinished);
```

fetchProjects():
```cpp
QUrl url("https://api.todoist.com/rest/v2/projects");
QNetworkRequest request(url);
request.setRawHeader("Authorization", QString("Bearer %1").arg(m_apiToken).toUtf8());
QNetworkReply* reply = m_networkManager->get(request);
connect(reply, &QNetworkReply::finished, this, &TodoistClient::onProjectsReplyFinished);
```

onTasksReplyFinished():
- Get reply with qobject_cast<QNetworkReply*>(sender())
- Check reply->error() != QNetworkReply::NoError
  - Handle specific errors: 401 -> "Invalid API token", 429 -> "Rate limited", others -> generic
  - Emit errorOccurred with user-friendly message
  - Call reply->deleteLater() and return
- Parse JSON with QJsonDocument::fromJson
- Handle JSON parse errors
- Iterate array, call Task::fromJson for each object
- Look up project names from m_projectNames cache, set projectName on each task
- Emit tasksFetched with QVector<Task>
- CRITICAL: Call reply->deleteLater() to prevent memory leak

onProjectsReplyFinished():
- Similar error handling as tasks
- Parse JSON array of projects
- Each project has "id" (string) and "name" (string)
- Store in m_projectNames map
- Emit projectsFetched signal
- Call reply->deleteLater()

Update CMakeLists.txt to include todoist_client.cpp
  </action>
  <verify>
Code compiles. TodoistClient can be instantiated with a token string. No runtime test yet (needs valid token and network).
  </verify>
  <done>
TodoistClient class exists with fetchAllTasks(), fetchProjects(), proper error handling, and memory management (deleteLater on replies).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive error handling for API responses</name>
  <files>
    src/network/todoist_client.h
    src/network/todoist_client.cpp
  </files>
  <action>
Enhance error handling in TodoistClient:

Add private helper method:
- `QString handleNetworkError(QNetworkReply* reply)` - returns user-friendly error message

Error mapping:
```cpp
QString TodoistClient::handleNetworkError(QNetworkReply* reply) {
    int statusCode = reply->attribute(QNetworkRequest::HttpStatusCodeAttribute).toInt();

    switch (statusCode) {
        case 401:
            return "Invalid API token. Please check your token in settings.";
        case 403:
            return "Access forbidden. Your token may not have the required permissions.";
        case 404:
            return "API endpoint not found. The Todoist API may have changed.";
        case 429:
            return "Too many requests. Please wait a moment and try again.";
        case 500:
        case 502:
        case 503:
        case 504:
            return "Todoist server error. Please try again later.";
        default:
            if (reply->error() == QNetworkReply::NoError) {
                return QString(); // No error
            }
            // Network-level errors (no connection, timeout, etc.)
            return QString("Network error: %1").arg(reply->errorString());
    }
}
```

Update onTasksReplyFinished and onProjectsReplyFinished to use this helper.

Add logging (qDebug/qWarning):
- Log successful fetches with task/project count
- Log errors with status code and message

Consider timeout: QNetworkRequest::setTransferTimeout() can set a timeout (Qt 5.15 supports this). Set 30 second timeout to avoid hanging on slow connections.

Add to header:
```cpp
private:
    QString handleNetworkError(QNetworkReply* reply);
```
  </action>
  <verify>
Code compiles. Error messages are user-friendly strings, not technical codes.
  </verify>
  <done>
All HTTP error codes mapped to user-friendly messages. Network errors handled. Logging in place for debugging.
  </done>
</task>

</tasks>

<verification>
1. `cmake -B build && cmake --build build` compiles without errors
2. TodoistClient class includes all required methods and signals
3. Error handling covers 401, 403, 429, 5xx status codes
4. All QNetworkReply pointers have deleteLater() called
5. Authorization header correctly formatted as "Bearer {token}"
6. Project name lookup implemented (m_projectNames cache)
</verification>

<success_criteria>
- TodoistClient fetches from https://api.todoist.com/rest/v2/tasks
- Bearer token authentication in Authorization header
- Tasks parsed via Task::fromJson
- Projects fetched and cached for name lookup
- Error signals emitted with user-friendly messages
- No memory leaks (reply->deleteLater() on all paths)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-task-display/01-02-SUMMARY.md`
</output>
