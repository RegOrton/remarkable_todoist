---
phase: 02-sync-task-completion
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/controllers/appcontroller.h
  - src/controllers/appcontroller.cpp
  - qml/main.qml
  - qml/TaskDelegate.qml
  - src/main.cpp
autonomous: false

must_haves:
  truths:
    - "User can tap checkbox to complete a task"
    - "Completed task shows visual feedback immediately"
    - "Sync status indicator shows online/offline state"
    - "Sync status shows pending operation count"
  artifacts:
    - path: "src/controllers/appcontroller.h"
      provides: "completeTask() Q_INVOKABLE and syncManager access"
      contains: "Q_INVOKABLE void completeTask"
    - path: "qml/main.qml"
      provides: "Sync status indicator in header"
      contains: "syncManager"
    - path: "qml/TaskDelegate.qml"
      provides: "Checkbox wired to completeTask"
      contains: "completeTask"
  key_links:
    - from: "qml/TaskDelegate.qml"
      to: "src/controllers/appcontroller.h"
      via: "appController.completeTask() call"
      pattern: "appController.completeTask"
    - from: "src/controllers/appcontroller.cpp"
      to: "src/models/taskmodel.h"
      via: "setTaskCompleted() for optimistic UI"
      pattern: "setTaskCompleted"
    - from: "src/controllers/appcontroller.cpp"
      to: "src/network/sync_manager.h"
      via: "queueTaskCompletion() for sync"
      pattern: "queueTaskCompletion"
---

<objective>
Integrate SyncManager with AppController and wire up QML for task completion and sync status display.

Purpose: This is the final integration plan that connects all the pieces. The user taps a checkbox, the UI updates immediately (optimistic), and the sync happens in the background. The sync status indicator shows whether we're online and how many operations are pending.

Output: Complete working task completion flow with sync status UI.
</objective>

<execution_context>
@/home/reg/.claude/get-shit-done/workflows/execute-plan.md
@/home/reg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sync-task-completion/02-RESEARCH.md

# Files to modify
@src/controllers/appcontroller.h
@src/controllers/appcontroller.cpp
@qml/main.qml
@qml/TaskDelegate.qml
@src/main.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate SyncManager into AppController</name>
  <files>src/controllers/appcontroller.h, src/controllers/appcontroller.cpp</files>
  <action>
Add SyncManager to AppController and expose completeTask():

In appcontroller.h:
- Add forward declaration: `class SyncManager;`
- Add property: `Q_PROPERTY(SyncManager* syncManager READ syncManager CONSTANT)`
- Add accessor: `SyncManager* syncManager() const { return m_syncManager; }`
- Add Q_INVOKABLE method: `Q_INVOKABLE void completeTask(const QString& taskId);`
- Add private member: `SyncManager* m_syncManager;`

In appcontroller.cpp:
- Include sync_manager.h
- In constructor: Create SyncManager after TodoistClient: `m_syncManager = new SyncManager(m_todoistClient, this);`
- Implement completeTask(taskId):
  1. Optimistic UI update: `m_taskModel->setTaskCompleted(taskId, true);`
  2. Queue for sync: `m_syncManager->queueTaskCompletion(taskId);`
- Optionally connect syncManager signals for logging/debugging

The optimistic update pattern from RESEARCH.md:
- Update UI immediately for responsive feel
- Queue operation for background sync
- If sync fails, user can see pending count and status
  </action>
  <verify>
Build with `cd /home/reg/Remarkable_Todoist/build && cmake .. && make -j$(nproc)` - no compile errors
Grep for "completeTask" in appcontroller.cpp to confirm implementation
Grep for "setTaskCompleted" in appcontroller.cpp to confirm optimistic update
  </verify>
  <done>AppController has completeTask() that does optimistic UI update and queues sync</done>
</task>

<task type="auto">
  <name>Task 2: Add sync status indicator to QML header</name>
  <files>qml/main.qml, src/main.cpp</files>
  <action>
Update main.qml to show sync status in header:

In main.qml, add sync status between the title and buttons in the header RowLayout:

```qml
// After "Todoist" title Text, before Item { Layout.fillWidth: true }

// Sync status indicator
RowLayout {
    spacing: 12

    // Online/offline dot
    Rectangle {
        width: 16
        height: 16
        radius: 8
        color: appController.syncManager.isOnline ? "#4CAF50" : "#F44336"
    }

    Text {
        text: {
            if (!appController.syncManager.isOnline) {
                return "Offline"
            } else if (appController.syncManager.pendingCount > 0) {
                return "Syncing " + appController.syncManager.pendingCount + "..."
            } else if (appController.syncManager.isSyncing) {
                return "Syncing..."
            } else {
                return "Synced"
            }
        }
        font.pixelSize: 20
        color: mutedColor
    }
}
```

In src/main.cpp:
- Register SyncManager for QML: Add `qmlRegisterUncreatableType<SyncManager>("RemarkableTodoist", 1, 0, "SyncManager", "Access via appController.syncManager");`
- This allows QML to access SyncManager properties

Note: SyncManager is already accessible via appController.syncManager, but registering the type ensures QML can understand the properties.
  </action>
  <verify>
Build with `cd /home/reg/Remarkable_Todoist/build && cmake .. && make -j$(nproc)` - no compile errors
Grep for "syncManager" in main.qml to confirm status indicator added
  </verify>
  <done>Sync status indicator visible in header showing online/offline and pending count</done>
</task>

<task type="auto">
  <name>Task 3: Wire checkbox to completeTask in TaskDelegate</name>
  <files>qml/TaskDelegate.qml</files>
  <action>
Update TaskDelegate.qml to call completeTask when checkbox is tapped:

Replace the existing MouseArea onClicked in the checkbox:

```qml
MouseArea {
    anchors.fill: parent
    onClicked: {
        // Only allow completing non-completed tasks
        if (!model.completed) {
            appController.completeTask(model.id)
        }
    }
}
```

The checkbox already shows checkmark when model.completed is true (via the Text element with "model.completed ? checkmark : ''").

The flow:
1. User taps checkbox
2. QML calls appController.completeTask(model.id)
3. AppController calls taskModel.setTaskCompleted(id, true) - UI updates immediately
4. AppController calls syncManager.queueTaskCompletion(id) - syncs in background
5. TaskDelegate sees model.completed changed via dataChanged signal
6. Checkmark appears, title gets strikethrough

Key point: Only complete non-completed tasks. Re-tapping a completed task does nothing (reopening tasks would be a separate feature).
  </action>
  <verify>
Build with `cd /home/reg/Remarkable_Todoist/build && cmake .. && make -j$(nproc)` - no compile errors
Grep for "completeTask" in TaskDelegate.qml to confirm wiring
  </verify>
  <done>Checkbox in TaskDelegate calls appController.completeTask() when tapped</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete task completion flow with sync status indicator:
- Tap checkbox to complete task (optimistic UI update)
- Sync status indicator in header (online/offline, pending count)
- Background sync of task completion to Todoist API
  </what-built>
  <how-to-verify>
1. Build and run on desktop: `cd build && cmake .. && make && ./remarkable-todoist`
2. Verify sync status shows "Synced" or "Offline" in header
3. Click a checkbox on a task
4. Verify: Task immediately shows checkmark and strikethrough
5. Verify: If online, sync status briefly shows "Syncing 1..." then "Synced"
6. Verify: Task remains completed after clicking Refresh
7. (Optional) Test offline: Disconnect network, complete task, verify "Offline" shown and pending count increases
  </how-to-verify>
  <resume-signal>Type "approved" if task completion works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Project builds without errors
2. completeTask() wired from QML to AppController
3. Sync status indicator visible and updates correctly
4. Task completion shows immediate visual feedback
5. Completed tasks sync to Todoist (visible in Todoist app/web)
</verification>

<success_criteria>
- User can tap checkbox to complete task
- Completed task shows checkmark and strikethrough immediately
- Sync status indicator shows online/offline state
- Pending count shows when operations queued
- Completed tasks persist after refresh (synced to server)
</success_criteria>

<output>
After completion, create `.planning/phases/02-sync-task-completion/02-04-SUMMARY.md`
</output>
