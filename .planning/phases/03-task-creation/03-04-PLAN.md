---
phase: 03-task-creation
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/controllers/appcontroller.h
  - src/controllers/appcontroller.cpp
  - src/main.cpp
  - qml/main.qml
autonomous: false

must_haves:
  truths:
    - "User can navigate to Add Task screen from task list"
    - "User can write task name, recognize it, and submit"
    - "Submitted task appears immediately in the task list"
    - "Tasks created offline are queued and submitted when WiFi reconnects"
    - "User can cancel and return to task list"
  artifacts:
    - path: "src/controllers/appcontroller.h"
      provides: "createTask and recognizeHandwriting methods"
      contains: "createTask"
    - path: "src/controllers/appcontroller.cpp"
      provides: "Task creation with optimistic UI and sync queue"
      contains: "createTask"
    - path: "qml/main.qml"
      provides: "StackView navigation between task list and add task screen"
      contains: "StackView"
    - path: "src/main.cpp"
      provides: "HandwritingRecognizer exposed to QML"
      contains: "HandwritingRecognizer"
  key_links:
    - from: "qml/main.qml"
      to: "qml/AddTaskScreen.qml"
      via: "StackView push/pop navigation"
      pattern: "stackView.push"
    - from: "qml/AddTaskScreen.qml"
      to: "src/controllers/appcontroller.cpp"
      via: "appController.createTask() called on submit"
      pattern: "appController.createTask"
    - from: "src/controllers/appcontroller.cpp"
      to: "src/network/sync_manager.cpp"
      via: "m_syncManager->queueTaskCreation() for sync"
      pattern: "queueTaskCreation"
    - from: "src/controllers/appcontroller.cpp"
      to: "src/models/taskmodel.h"
      via: "Optimistic UI - add task to model before sync"
      pattern: "addTask|insertTask"
    - from: "qml/AddTaskScreen.qml"
      to: "src/ocr/handwriting_recognizer.h"
      via: "appController.recognizeHandwriting() called on Recognize tap"
      pattern: "recognizeHandwriting"
---

<objective>
Wire everything together: AppController gets createTask() and recognizeHandwriting() methods, main.qml gets navigation to AddTaskScreen, and the complete end-to-end flow works — write, recognize, submit, see task in list.

Purpose: This is the final integration plan that connects the drawing canvas (Plan 02), OCR (Plan 03), and sync backend (Plan 01) into a working feature. After this plan, the user can create tasks via handwriting.

Output: Complete task creation flow from handwriting to Todoist sync.
</objective>

<execution_context>
@/home/reg/.claude/get-shit-done/workflows/execute-plan.md
@/home/reg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-task-creation/03-01-SUMMARY.md
@.planning/phases/03-task-creation/03-02-SUMMARY.md
@.planning/phases/03-task-creation/03-03-SUMMARY.md

@src/controllers/appcontroller.h
@src/controllers/appcontroller.cpp
@src/main.cpp
@qml/main.qml
@qml/AddTaskScreen.qml
@src/ocr/handwriting_recognizer.h
@src/network/sync_manager.h
@src/models/taskmodel.h
@src/models/task.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createTask and recognizeHandwriting to AppController</name>
  <files>
    src/controllers/appcontroller.h
    src/controllers/appcontroller.cpp
    src/models/taskmodel.h
    src/models/taskmodel.cpp
    src/main.cpp
  </files>
  <action>
**1. Add addTask method to TaskModel:**

In `taskmodel.h`, add:
```cpp
void addTask(const Task& task);  // Add a single task to the top of the list
```

In `taskmodel.cpp`, implement:
```cpp
void TaskModel::addTask(const Task& task) {
    beginInsertRows(QModelIndex(), 0, 0);  // Insert at top
    m_tasks.prepend(task);
    endInsertRows();
}
```

**2. Add HandwritingRecognizer to AppController:**

In `appcontroller.h`:
- Add `#include "../ocr/handwriting_recognizer.h"`
- Add private member: `HandwritingRecognizer* m_recognizer;`
- Add Q_INVOKABLE methods:
  ```cpp
  Q_INVOKABLE void createTask(const QString& content);
  Q_INVOKABLE QString recognizeHandwriting(const QString& imagePath);
  ```
- Add signal: `void taskCreated()` — notify QML that task was added to model

In `appcontroller.cpp`:
- In constructor: `m_recognizer = new HandwritingRecognizer(this);`
- In `initialize()`, after creating SyncManager: `m_recognizer->initialize();` (log warning if fails but don't block app)

- Implement `createTask(const QString& content)`:
  ```cpp
  void AppController::createTask(const QString& content) {
      if (content.trimmed().isEmpty()) {
          qWarning() << "Cannot create task with empty content";
          return;
      }

      // Generate temp ID for optimistic UI tracking
      QString tempId = "temp_" + QUuid::createUuid().toString(QUuid::WithoutBraces);

      // Optimistic UI: add task to model immediately
      Task newTask;
      newTask.id = tempId;
      newTask.title = content.trimmed();
      newTask.priority = 1;  // Default priority
      newTask.completed = false;
      m_taskModel->addTask(newTask);

      // Queue for sync
      m_syncManager->queueTaskCreation(content.trimmed(), tempId);

      emit taskCreated();
      qDebug() << "Task created (optimistic):" << content << "tempId:" << tempId;
  }
  ```

- Implement `recognizeHandwriting(const QString& imagePath)`:
  ```cpp
  QString AppController::recognizeHandwriting(const QString& imagePath) {
      if (!m_recognizer || !m_recognizer->isReady()) {
          qWarning() << "Handwriting recognizer not ready";
          return QString();
      }
      QString result = m_recognizer->recognizeFile(imagePath);
      qDebug() << "Recognized text:" << result;
      return result;
  }
  ```

**3. Expose HandwritingRecognizer registration in main.cpp:**

No additional QML registration needed — recognizeHandwriting is exposed through AppController which is already a context property. But add `#include "ocr/handwriting_recognizer.h"` is NOT needed in main.cpp since AppController handles it internally.

Add `#include <QUuid>` to appcontroller.cpp for tempId generation.

**4. Connect SyncManager signals for task creation feedback:**

In `appcontroller.cpp` `initialize()`, after creating SyncManager, connect:
```cpp
connect(m_syncManager, &SyncManager::taskCreateSynced,
        this, [this](const QString& tempId, const QString& serverTaskId) {
    qDebug() << "Task synced, tempId:" << tempId << "-> serverId:" << serverTaskId;
    // TODO: Could update the tempId in the model to the real server ID
    // For v1, the task will get the real ID on next refresh
});
```

This is sufficient for v1 — on next refresh(), the full task list from server replaces the model.
  </action>
  <verify>
Build: `cd /home/reg/Remarkable_Todoist/build && cmake .. && make 2>&1 | tail -30`. Verify new methods exist: `grep -n "createTask\|recognizeHandwriting\|addTask" src/controllers/appcontroller.h src/controllers/appcontroller.cpp src/models/taskmodel.h`.
  </verify>
  <done>
AppController has createTask(content) with optimistic UI and sync queue, recognizeHandwriting(imagePath) wrapping Tesseract OCR. TaskModel has addTask() for prepending new tasks. SyncManager task creation signals connected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation to main.qml with StackView</name>
  <files>
    qml/main.qml
  </files>
  <action>
Refactor `main.qml` to use StackView for navigation between the task list and AddTaskScreen.

**Changes to main.qml:**

1. Replace the current flat layout with a StackView-based navigation:

The current structure is:
```
ApplicationWindow {
    ColumnLayout {
        Header (with Refresh, Exit, sync status)
        Content (ListView with tasks)
    }
}
```

Change to:
```
ApplicationWindow {
    StackView {
        id: stackView
        initialItem: taskListPage

        Component {
            id: taskListPage
            // Move existing ColumnLayout here (header + task list)
            // Add "Add Task" button to header
        }

        Component {
            id: addTaskPage
            AddTaskScreen {
                // Wire signals
            }
        }
    }
}
```

2. **Task list page modifications:**
- Add an "Add Task" button in the header between the sync status and Refresh button
- Button text: "+" (large, 36px) — or "Add" (24px) — consistent with existing button style
- Button dimensions: same as Refresh button (implicitWidth: 120, implicitHeight: 70)
- On click: `stackView.push(addTaskPage)`

3. **AddTaskScreen wiring:**
```qml
Component {
    id: addTaskPage
    AddTaskScreen {
        onTaskSubmitted: function(taskContent) {
            appController.createTask(taskContent)
            stackView.pop()  // Return to task list
        }
        onCancelled: {
            stackView.pop()  // Return to task list
        }

        // Wire the Recognize button
        // The AddTaskScreen needs to:
        // 1. Save canvas to a temp file
        // 2. Call appController.recognizeHandwriting(tempFile)
        // 3. Display the result
    }
}
```

4. **Recognition flow in AddTaskScreen integration:**

The "Recognize" button in AddTaskScreen needs to:
- Save the canvas to a temp PNG file using `canvas.save("/tmp/remarkable-todoist-canvas.png")`
- Call `appController.recognizeHandwriting("/tmp/remarkable-todoist-canvas.png")`
- Set the recognizedText property with the result

Since recognizeHandwriting is synchronous (Tesseract runs inline), this can be done directly:
```qml
// In AddTaskScreen.qml, update the Recognize button onClicked:
onClicked: {
    recognizing = true
    canvas.save("/tmp/remarkable-todoist-canvas.png")
    var result = appController.recognizeHandwriting("/tmp/remarkable-todoist-canvas.png")
    recognizedText = result
    recognizing = false
}
```

If the AddTaskScreen was written with the Recognize button calling a parent-provided function, update it to call appController directly (since appController is a global context property).

5. **StackView transitions:** Set `StackView.transition` to use no animations:
```qml
StackView {
    id: stackView
    anchors.fill: parent
    pushEnter: null
    pushExit: null
    popEnter: null
    popExit: null
}
```
This is critical for e-ink — StackView animations cause ghosting.

6. **Move the ApplicationWindow color and readonly properties** to still be accessible. Since StackView items are Components, the color properties should be defined at the ApplicationWindow level (they already are).

**Important:** The StackView replaces the ColumnLayout that was directly inside ApplicationWindow. The existing header + task list content becomes the `initialItem` of the StackView.
  </action>
  <verify>
Build: `cd /home/reg/Remarkable_Todoist/build && cmake .. && make 2>&1 | tail -30`. Verify navigation elements: `grep -n "StackView\|stackView\|addTask\|push\|pop" qml/main.qml`. Verify Add button exists: `grep -n "Add" qml/main.qml`.
  </verify>
  <done>
main.qml uses StackView with no-animation transitions. Task list has "Add" button that pushes AddTaskScreen. AddTaskScreen's taskSubmitted signal calls appController.createTask() and pops back. Recognize button saves canvas and calls appController.recognizeHandwriting(). Cancel pops back to task list.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete task creation flow: handwriting canvas, Tesseract OCR recognition, task submission with optimistic UI, offline queue support, and navigation between task list and add task screen.
  </what-built>
  <how-to-verify>
1. Build the project: `cd /home/reg/Remarkable_Todoist/build && cmake .. && make`
2. Run on desktop (or deploy to reMarkable): verify the task list shows with an "Add" button
3. Tap "Add" button — should navigate to AddTaskScreen with drawing canvas
4. Draw text with mouse/stylus on the canvas
5. Tap "Recognize" — should show recognized text preview below canvas
6. If text is wrong, tap "Clear" and retry
7. Tap "Submit Task" — should return to task list with new task at the top
8. Verify the task appears in Todoist (check todoist.com or the mobile app)
9. Test offline: disconnect WiFi, create a task, reconnect — task should sync

Expected behavior:
- Canvas shows black strokes on white background
- Recognition produces readable text (may not be perfect — that's OK for v1)
- New task appears immediately at top of task list (optimistic UI)
- Navigation is instant (no animation artifacts on e-ink)
- Cancel button returns to task list without creating a task
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. AppController.createTask() adds task to model + queues for sync
2. AppController.recognizeHandwriting() returns Tesseract OCR result
3. TaskModel.addTask() prepends new task to list
4. main.qml has StackView navigation with Add button
5. AddTaskScreen properly wired: recognize, submit, cancel all work
6. No animations in StackView transitions (e-ink safe)
7. Offline task creation queues correctly
8. End-to-end: write -> recognize -> submit -> see in list -> synced to Todoist
</verification>

<success_criteria>
- User can navigate to Add Task screen and back
- Handwriting on canvas is recognized to text via Tesseract
- Submitted task appears immediately in task list
- Task syncs to Todoist when online
- Offline-created tasks queue and sync on reconnect
- Human verification confirms the flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-task-creation/03-04-SUMMARY.md`
</output>
