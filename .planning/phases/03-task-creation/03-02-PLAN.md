---
phase: 03-task-creation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - qml/DrawingCanvas.qml
  - qml/qml.qrc
autonomous: true

must_haves:
  truths:
    - "User can draw on canvas with stylus and see ink strokes"
    - "User can clear the canvas to start over"
    - "Canvas captures stroke data that can be rendered to an image"
  artifacts:
    - path: "qml/DrawingCanvas.qml"
      provides: "Canvas component with stylus stroke capture and rendering"
      min_lines: 60
    - path: "qml/qml.qrc"
      provides: "QML resource file including DrawingCanvas.qml"
      contains: "DrawingCanvas.qml"
  key_links:
    - from: "qml/DrawingCanvas.qml"
      to: "Canvas QML element"
      via: "onPaint handler draws captured strokes"
      pattern: "Canvas"
    - from: "qml/DrawingCanvas.qml"
      to: "MouseArea/PointHandler"
      via: "captures stylus/touch input coordinates"
      pattern: "MouseArea|PointHandler"
---

<objective>
Create a reusable QML drawing canvas component that captures stylus handwriting input.

Purpose: The reMarkable 2's primary input method is the stylus. This canvas component lets users write task names by hand. It needs to work well on e-ink (high contrast, simple rendering) and capture strokes that can later be exported as an image for OCR.

Output: DrawingCanvas.qml component with stroke capture, rendering, clear function, and image export capability.
</objective>

<execution_context>
@/home/reg/.claude/get-shit-done/workflows/execute-plan.md
@/home/reg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@qml/main.qml
@qml/TaskDelegate.qml
@qml/qml.qrc
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DrawingCanvas QML component</name>
  <files>
    qml/DrawingCanvas.qml
  </files>
  <action>
Create `qml/DrawingCanvas.qml` — a self-contained QML component for handwriting input.

**Component structure:**

```
Item {
    id: drawingCanvas

    // Public API
    signal cleared()
    function clear() { ... }
    function isEmpty() { return strokes.length === 0 }
    function save(filePath) { canvas.save(filePath) }
    function grabToImage(callback) { canvas.grabToImage(callback) }

    property var strokes: []       // Array of stroke arrays
    property var currentStroke: [] // Current in-progress stroke

    Canvas {
        id: canvas
        anchors.fill: parent
        // rendering
    }

    MouseArea {
        // input capture
    }
}
```

**Canvas rendering:**
- Use Canvas QML element (built into Qt Quick, no extra dependencies)
- Black ink on white background for maximum e-ink contrast
- Line width: 3px (good balance for handwriting on 1404px-wide display)
- Use `lineCap: "round"` and `lineJoin: "round"` for smooth strokes
- In the `onPaint` handler, draw ALL strokes (not just current) because Canvas repaints from scratch
- Use `context.beginPath()`, `context.moveTo()`, `context.lineTo()`, `context.stroke()` for each stroke

**Input handling:**
- Use MouseArea (works for both stylus and touch on reMarkable via evdev)
- `onPressed`: Start new stroke, add first point `{x: mouse.x, y: mouse.y}`
- `onPositionChanged`: Add point to current stroke, call `canvas.requestPaint()`
- `onReleased`: Finalize current stroke, push to strokes array, reset currentStroke
- Do NOT use PointHandler or MultiPointHandler — MouseArea is simpler and works on reMarkable

**Clear function:**
- Reset strokes to empty array `[]`
- Reset currentStroke to `[]`
- Repaint canvas (will draw empty = white background)
- Emit cleared() signal

**Image export:**
- `save(filePath)`: Calls `canvas.save(filePath)` to save as PNG. Qt Canvas supports this natively.
- `grabToImage(callback)`: Calls `canvas.grabToImage(callback)` for in-memory image access

**Visual design (e-ink optimized):**
- White background (explicitly fill in onPaint before drawing strokes)
- Black strokes (#000000)
- 2px border (#333333) around canvas area for visual boundary
- No shadows, gradients, or transparency (bad for e-ink)

**Important implementation notes:**
- Canvas `onPaint` must redraw ALL strokes every time (Canvas does not retain drawn content between paint calls unless `renderStrategy: Canvas.Cooperative` is used — but the simpler approach is to just redraw all)
- Keep stroke data as simple JavaScript arrays of {x, y} objects for performance
- Do NOT use `requestAnimationFrame` — use `requestPaint()` which is the Qt Canvas equivalent
  </action>
  <verify>
Verify the file exists and has the expected structure: check for Canvas element, MouseArea, strokes property, clear function, save function. Build the project to verify QML resource compilation: `cd /home/reg/Remarkable_Todoist/build && cmake .. && make 2>&1 | tail -20`.
  </verify>
  <done>
DrawingCanvas.qml exists with: Canvas for rendering strokes, MouseArea for stylus/touch input, strokes array for data, clear() function, save()/grabToImage() for export. Black-on-white high contrast for e-ink. No external dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register DrawingCanvas in QML resources</name>
  <files>
    qml/qml.qrc
  </files>
  <action>
Add `DrawingCanvas.qml` to the QML resource file `qml/qml.qrc`.

Current content:
```xml
<RCC>
    <qresource prefix="/">
        <file>main.qml</file>
        <file>TaskDelegate.qml</file>
    </qresource>
</RCC>
```

Updated content:
```xml
<RCC>
    <qresource prefix="/">
        <file>main.qml</file>
        <file>TaskDelegate.qml</file>
        <file>DrawingCanvas.qml</file>
    </qresource>
</RCC>
```

This ensures DrawingCanvas.qml is compiled into the binary via Qt's resource system and can be referenced by other QML files as a component.
  </action>
  <verify>
Build the project: `cd /home/reg/Remarkable_Todoist/build && cmake .. && make 2>&1 | tail -20`. Should compile with no errors and include DrawingCanvas.qml in the resource bundle.
  </verify>
  <done>
DrawingCanvas.qml registered in qml.qrc and compiles into the application binary.
  </done>
</task>

</tasks>

<verification>
1. qml/DrawingCanvas.qml exists with Canvas + MouseArea + strokes + clear + save
2. qml/qml.qrc includes DrawingCanvas.qml
3. Project compiles cleanly
4. Component has no external dependencies beyond Qt Quick
</verification>

<success_criteria>
- DrawingCanvas.qml is a self-contained component with stroke capture and rendering
- clear() resets all strokes and repaints
- save(filePath) exports canvas as PNG image
- grabToImage(callback) provides in-memory image access
- High contrast black-on-white rendering suitable for e-ink
- Project compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-task-creation/03-02-SUMMARY.md`
</output>
