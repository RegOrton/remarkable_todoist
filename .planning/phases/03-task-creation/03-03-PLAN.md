---
phase: 03-task-creation
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/ocr/handwriting_recognizer.h
  - src/ocr/handwriting_recognizer.cpp
  - qml/AddTaskScreen.qml
  - qml/qml.qrc
  - CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "HandwritingRecognizer converts a PNG image to text using Tesseract"
    - "AddTaskScreen shows a drawing canvas, recognized text preview, and submit/clear/cancel buttons"
    - "User can see recognized text before submitting"
  artifacts:
    - path: "src/ocr/handwriting_recognizer.h"
      provides: "C++ class wrapping Tesseract OCR"
      contains: "recognize"
    - path: "src/ocr/handwriting_recognizer.cpp"
      provides: "Tesseract initialization and image-to-text conversion"
      contains: "tesseract"
    - path: "qml/AddTaskScreen.qml"
      provides: "Add task screen with DrawingCanvas, text preview, action buttons"
      contains: "DrawingCanvas"
    - path: "CMakeLists.txt"
      provides: "Tesseract library linkage"
      contains: "tesseract"
  key_links:
    - from: "src/ocr/handwriting_recognizer.cpp"
      to: "Tesseract API"
      via: "tesseract::TessBaseAPI for OCR"
      pattern: "TessBaseAPI"
    - from: "qml/AddTaskScreen.qml"
      to: "qml/DrawingCanvas.qml"
      via: "DrawingCanvas component embedded in layout"
      pattern: "DrawingCanvas"
---

<objective>
Build the handwriting recognition layer (Tesseract OCR wrapper) and the AddTaskScreen QML UI that combines the drawing canvas with text preview and action buttons.

Purpose: This plan bridges the drawing canvas (Plan 02) with the sync backend (Plan 01) by adding OCR capability and the screen layout. The user writes on the canvas, taps "Recognize", sees the text preview, and can then submit or retry.

Output: HandwritingRecognizer C++ class, AddTaskScreen.qml with full layout, CMake updated for Tesseract.
</objective>

<execution_context>
@/home/reg/.claude/get-shit-done/workflows/execute-plan.md
@/home/reg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-task-creation/03-01-SUMMARY.md
@.planning/phases/03-task-creation/03-02-SUMMARY.md

@src/controllers/appcontroller.h
@qml/DrawingCanvas.qml
@qml/main.qml
@CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HandwritingRecognizer C++ class with Tesseract OCR</name>
  <files>
    src/ocr/handwriting_recognizer.h
    src/ocr/handwriting_recognizer.cpp
    CMakeLists.txt
  </files>
  <action>
1. Create directory `src/ocr/` if it doesn't exist.

2. Create `src/ocr/handwriting_recognizer.h`:
```cpp
#ifndef HANDWRITING_RECOGNIZER_H
#define HANDWRITING_RECOGNIZER_H

#include <QObject>
#include <QString>
#include <QImage>

class HandwritingRecognizer : public QObject
{
    Q_OBJECT

public:
    explicit HandwritingRecognizer(QObject* parent = nullptr);
    ~HandwritingRecognizer();

    // Initialize Tesseract engine. Call once at startup.
    // Returns true if initialization succeeded.
    bool initialize();

    // Recognize text from a QImage (the canvas export)
    Q_INVOKABLE QString recognizeImage(const QImage& image);

    // Recognize text from a file path (PNG)
    Q_INVOKABLE QString recognizeFile(const QString& filePath);

    // Whether the engine is ready
    Q_INVOKABLE bool isReady() const { return m_initialized; }

private:
    void* m_tessApi;  // Opaque pointer to tesseract::TessBaseAPI (avoid header in .h)
    bool m_initialized;
};

#endif
```

3. Create `src/ocr/handwriting_recognizer.cpp`:
- Include `<tesseract/baseapi.h>` and `<leptonica/allheaders.h>`
- Constructor: set m_tessApi to nullptr, m_initialized to false
- Destructor: if m_tessApi is not null, cast to TessBaseAPI*, call End(), delete
- `initialize()`:
  - Create new `tesseract::TessBaseAPI`
  - Call `Init(NULL, "eng")` — NULL datapath tells Tesseract to search standard paths (/usr/share/tesseract-ocr/4.00/tessdata or TESSDATA_PREFIX env var)
  - If Init returns non-zero, log error, return false
  - Set page segmentation mode to `PSM_SINGLE_LINE` using `SetPageSegMode(tesseract::PSM_SINGLE_LINE)` — task names are typically a single line of text
  - Store the TessBaseAPI pointer in m_tessApi, set m_initialized = true, return true
  - If Init fails, set m_initialized = false, return false

- `recognizeImage(const QImage& image)`:
  - If not initialized, return empty string
  - Convert QImage to format suitable for Tesseract: `image.convertToFormat(QImage::Format_Grayscale8)`
  - Cast m_tessApi to `tesseract::TessBaseAPI*`
  - Call `SetImage(grayImage.bits(), grayImage.width(), grayImage.height(), 1, grayImage.bytesPerLine())`
  - Call `GetUTF8Text()` to get recognized text
  - Convert to QString, trim whitespace with `.trimmed()`
  - Free the Tesseract text with `delete[]`
  - Return the trimmed QString

- `recognizeFile(const QString& filePath)`:
  - Load QImage from filePath
  - If load fails, return empty string
  - Call recognizeImage(image) and return result

4. Update `CMakeLists.txt`:
- Add source files to SOURCES:
  ```
  src/ocr/handwriting_recognizer.cpp
  ```
- Find and link Tesseract and Leptonica:
  ```cmake
  # Find Tesseract OCR (for handwriting recognition)
  find_package(PkgConfig REQUIRED)
  pkg_check_modules(TESSERACT REQUIRED tesseract)
  pkg_check_modules(LEPTONICA REQUIRED lept)
  ```
- Add include directories:
  ```cmake
  target_include_directories(remarkable-todoist PRIVATE
      ${TESSERACT_INCLUDE_DIRS}
      ${LEPTONICA_INCLUDE_DIRS}
  )
  ```
- Add link libraries:
  ```cmake
  target_link_libraries(remarkable-todoist
      Qt6::Core
      Qt6::Gui
      Qt6::Network
      Qt6::Qml
      Qt6::Quick
      Qt6::QuickControls2
      ${TESSERACT_LIBRARIES}
      ${LEPTONICA_LIBRARIES}
  )
  ```

**Important cross-compilation note:** For desktop development/testing, install `libtesseract-dev` and `libleptonica-dev`. For reMarkable cross-compilation, Tesseract .so files need to be in the sysroot. Add a comment in CMakeLists.txt noting this. The build-rm.sh script may need PKG_CONFIG_PATH pointed at the sysroot's pkgconfig.

**Important:** Use opaque void* pointer in the header to avoid requiring Tesseract headers in every file that includes handwriting_recognizer.h. Cast to TessBaseAPI* only in the .cpp file.
  </action>
  <verify>
For desktop build (with tesseract-dev installed): `cd /home/reg/Remarkable_Todoist/build && cmake .. && make 2>&1 | tail -30`. Check that HandwritingRecognizer compiles. If tesseract-dev is not installed, install it first: `sudo apt-get install -y libtesseract-dev libleptonica-dev tesseract-ocr-eng`.
  </verify>
  <done>
HandwritingRecognizer class wraps Tesseract OCR with initialize(), recognizeImage(), recognizeFile() methods. CMakeLists.txt links Tesseract and Leptonica. Desktop build compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AddTaskScreen QML with drawing canvas and text preview</name>
  <files>
    qml/AddTaskScreen.qml
    qml/qml.qrc
  </files>
  <action>
Create `qml/AddTaskScreen.qml` — the full "Add Task" screen layout.

**Screen layout (top to bottom, 1404x1872 resolution):**

```
+------------------------------------------+
| [Cancel]     Add Task        [Clear]     |  <- Header (100px)
+------------------------------------------+
|                                          |
|         DrawingCanvas                    |  <- Drawing area (~1000px)
|    (write your task name here)           |
|                                          |
+------------------------------------------+
|  Recognized text:                        |  <- Preview area (~200px)
|  "Buy groceries"                         |
|  [Recognize]                             |
+------------------------------------------+
|                                          |
|  [Submit Task]                           |  <- Action area (~150px)
|                                          |
+------------------------------------------+
```

**Component structure:**

```qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Item {
    id: addTaskScreen

    signal taskSubmitted(string taskContent)
    signal cancelled()

    property string recognizedText: ""
    property bool recognizing: false

    // ... layout
}
```

**Header (100px):**
- Cancel button (left) — emits cancelled() signal
- "Add Task" title text (center, 36px bold)
- Clear button (right) — calls drawingCanvas.clear() and resets recognizedText

**Drawing area (~1000px):**
- DrawingCanvas component filling most of the screen
- Placeholder text "Write task name here..." shown when canvas is empty (centered, muted color, disappears when user starts drawing)
- 2px border around the canvas (#333333)

**Preview area (~200px):**
- Label "Recognized text:" (20px, muted)
- Text display of recognizedText (26px, bold, black) — or "No text recognized" if empty
- "Recognize" button — calls the recognition function (exposed by AppController in Plan 04)
- Show "Recognizing..." text while recognition is in progress (recognizing property)

**Action area (~150px):**
- "Submit Task" button — large, full-width, prominent (3px border, 70px height)
- Enabled only when recognizedText is not empty
- On click: emits taskSubmitted(recognizedText)

**Button styling:** Follow exact same pattern as main.qml buttons (contentItem Text + background Rectangle, black text, white background, 3px border, pressed state #e0e0e0). E-ink optimized: no animations, no shadows.

**Signals for parent integration:**
- `taskSubmitted(string taskContent)` — parent handles actual task creation
- `cancelled()` — parent navigates back to task list

**Properties for parent to control:**
- `recognizedText` — set by parent after OCR completes
- `recognizing` — set by parent during OCR processing
- `function getCanvasImage()` — returns a reference to the drawing canvas for the parent to grab the image from. Expose `drawingCanvas` as a property alias: `property alias canvas: drawingCanvas`

**Update qml.qrc** to include AddTaskScreen.qml.

**E-ink considerations:**
- All colors are black/white/gray — no color
- Large touch targets for all buttons (minimum 56px height)
- No animations or transitions
- Clear visual hierarchy with borders and spacing
  </action>
  <verify>
Verify files exist and have expected content. Build project: `cd /home/reg/Remarkable_Todoist/build && cmake .. && make 2>&1 | tail -20`. Check that AddTaskScreen.qml compiles into resources. Grep for key elements: `grep -n "DrawingCanvas\|taskSubmitted\|cancelled\|recognizedText\|Submit" qml/AddTaskScreen.qml`.
  </verify>
  <done>
AddTaskScreen.qml has: DrawingCanvas for handwriting input, text preview area showing recognized text, Recognize button, Submit Task button (enabled when text recognized), Cancel and Clear buttons, proper signals for parent integration. Registered in qml.qrc. E-ink optimized styling.
  </done>
</task>

</tasks>

<verification>
1. src/ocr/handwriting_recognizer.h and .cpp exist with Tesseract integration
2. HandwritingRecognizer has initialize(), recognizeImage(), recognizeFile()
3. CMakeLists.txt links tesseract and leptonica libraries
4. qml/AddTaskScreen.qml has DrawingCanvas, text preview, action buttons
5. qml/qml.qrc includes both DrawingCanvas.qml and AddTaskScreen.qml
6. Project compiles on desktop with tesseract-dev installed
</verification>

<success_criteria>
- HandwritingRecognizer compiles and links against Tesseract
- AddTaskScreen.qml presents a complete UI for handwriting -> recognition -> submission flow
- All buttons follow established e-ink styling patterns
- No new Qt modules required beyond existing dependencies + Tesseract
</success_criteria>

<output>
After completion, create `.planning/phases/03-task-creation/03-03-SUMMARY.md`
</output>
